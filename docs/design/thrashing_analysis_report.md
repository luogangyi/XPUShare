# 4-Pod 同 GPU 性能分析报告

## 1. 现象描述
在 4 个 Pod (每 Pod ~12GB) 运行于同一 GPU (16GB/24GB VRAM) 的测试中：
- **Pod 1**: 成功完成了任务，并在后期达到了满速 (~25 it/s)。
- **Pod 2/3/4**: 在 Pod 1 结束后，性能未能恢复，长期维持在极低速度 (`1.4s/it` - `20s/it`)，并在进度 2%-5% 处停滞。

## 2. 日志深度分析

### Pod 1 (成功者)
- **行为**:
  - `[00:19]` 获得锁，开始爬坡。
  - `[03:57]` (日志时间可能为 tqdm 累计) 此处有一段奇怪的日志跳变，但关键是它最终完成了。
  - `100% ... 25.85it/s`.
- **原因**: 它是第一个启动并获得锁的，可能在其他 Pod 申请大量内存引发严重换页前，已经建立好了 Working Set。或者它在调度竞争中获得了最初的优势。

### Pod 2 (受害者)
- **关键日志**:
  ```
  [02:39] Pending Kernel Window is 128
  [NVSHARE][WARN]: Critical timeout (26 s). AIMD reduced window to 4
  ```
  - **解读**: 在一次 `cuCtxSynchronize` 中耗时 **26秒**。这通常是因为严重的 **Page Faults** (缺页中断)。GPU 正在从 host 内存搬运大量数据。
- **时间片耗尽**:
  ```
  [...time passes...]
  [02:46] Received DROP_LOCK
  ```
  - Pod 在经历长时间卡顿（搬运数据）后，刚准备运行，调度器的时间片可能就到了，强制释放锁 (`DROP_LOCK`)。
  - **恶性循环**: 下次获得锁时，内存可能已被其他 Pod (如 Pod 3/4) 挤出显存，需要再次花费 ~20s 搬运数据，导致再次超时或无法在时间片内完成计算。

### Pod 3 & 4
- 同样表现出 `Pending Kernel Window` 在 2-8 之间徘徊，且伴随大量 `Early release timer elapsed`，说明它们甚至无法填满流水线，因为大部分时间都在等待数据传输。

## 3. 根本原因：UVM 颠簸 (Thrashing)

### 为什么 Pod 1 结束后没有改善？
- **剩余负载仍过高**:
  - 剩余 3 个 Pod，每个需求 12GB，总计 **36GB**。
  - GPU 显存假设为 16GB 或 24GB。
  - **36GB >> 物理显存**。
  - 这意味着任何时刻，都至少有 1-2 个 Pod 的内存完全在 Host 端。
- **切换开销 > 时间片**:
  - 如果调度器的时间片 (Time Slice) 设定为 10-30秒。
  - 而 12GB 数据的换入换出 (Swap-in/Swap-out) 在 PCIe带宽限制下可能需要 10-20秒 (取决于 PCIe Gen3/4 和并发争抢)。
  - **结果**: Pod 获得锁 -> 疯狂换页 (CPU/PCIe 满载，GPU 空闲) -> 时间片到 -> 释放锁 -> 内存被下一个 Pod 冲掉。
  - 这是一个经典的 **Live Lock (活锁)** 现象：系统忙于换页，几乎不做有效计算。

## 4. 改进建议

### A. 增加最小调度时间 (Min Time Slice)
目前的调度策略可能过于公平（轮转过快）。对于内存超卖场景，必须让 Pod 有足够时间“回本”（Amortize swap cost）。
- **建议**: 在检测到严重超卖时，将持有锁的最短时间延长到 **30秒 - 60秒**。

### B. 限制并发度 (Admission Control)
当检测到内存严重不足时，不要让 3 个 Pod 轮转。
- **建议**: 暂时挂起 Pod 4，只让 Pod 2 和 3 轮转（或者最好只运行 1 个）。
- `nvshare` 目前可能没有实现这种全局排队逻辑。

### C. 优化预热逻辑 (针对 hook.c)
- 目前 `hook.c` 的预热 (`NVSHARE_KERN_WARMUP_PERIOD_SEC`) 是基于由于“刚获得锁”的时间。
- 如果换页需要 26s，而预热只有 30s，可能刚预热完就遇到超时降级。
- 但核心问题不在流控窗口，而在物理带宽瓶颈。

## 结论
这不是代码 Bug，而是**物理资源瓶颈下的调度策略失效**。在 3x 内存超卖下，必须采用更激进的**更长的时间片**或**串行化执行**策略，否则 PCIe 带宽将成为无法逾越的瓶颈。
